package lib

import (
	"path/filepath"
	"strings"
)

type CppCodeGenerator struct {
	BaseCodeGenerator
}

func NewCppCodeGenerator() *CppCodeGenerator {
	newObj := new(CppCodeGenerator)

	return newObj
}

func (this *CppCodeGenerator) Close() {
	this.close()
}

func (this *CppCodeGenerator) Generate(
	descriptor *TableDescriptor,
	reader string, outputDir string, newLineType NewLineType) bool {

	this.init(descriptor, reader, newLineType)

	for _, def := range this.descriptor.GlobalStructs {
		underscoreName := UtilCamelToUnderscore(def.Name)

		headerFilePath := filepath.Join(outputDir, underscoreName+".h")
		headerFileContent := this.generateGlobalStructHeaderFile(def)
		if UtilWriteAllText(headerFilePath, headerFileContent) == false {
			return false
		}

		sourceFilePath := filepath.Join(outputDir, underscoreName+".cc")
		sourceFileContent := this.generateGlobalStructSourceFile(def)
		if UtilWriteAllText(sourceFilePath, sourceFileContent) == false {
			return false
		}
	}

	return true
}

func (this *CppCodeGenerator) generateGlobalStructHeaderFile(
	structDef *StructDef) string {

	var sb strings.Builder

	this.writeDontEditComment(&sb)
	this.writeGlobalStructHeaderFileIncludeGuardStart(&sb, structDef)
	this.writeNamespaceDeclStart(&sb)
	this.writeNamespaceDeclEnd(&sb)
	this.writeGlobalStructHeaderFileIncludeGuardEnd(&sb)

	return sb.String()
}

func (this *CppCodeGenerator) generateGlobalStructSourceFile(
	structDef *StructDef) string {

	var sb strings.Builder

	this.writeDontEditComment(&sb)
	this.writeNamespaceDeclStart(&sb)
	this.writeNamespaceDeclEnd(&sb)

	return sb.String()
}

func (this *CppCodeGenerator) writeDontEditComment(
	sb *strings.Builder) {

	this.writeLine(sb,
		"/*")
	this.writeLine(sb,
		" * Generated by brickred table compiler.")
	this.writeLine(sb,
		" * Do not edit unless you are sure that you know what you are doing.")
	this.writeLine(sb,
		" */")
}

func (this *CppCodeGenerator) writeNamespaceDeclStart(
	sb *strings.Builder) {

	readerDef, ok := this.descriptor.Readers[this.reader]
	if ok == false {
		return
	}
	namespaceName := strings.Join(readerDef.NamespaceParts, "::")

	this.writeEmptyLine(sb)
	this.writeLineFormat(sb,
		"namespace %s {",
		namespaceName)
}

func (this *CppCodeGenerator) writeNamespaceDeclEnd(
	sb *strings.Builder) {

	readerDef, ok := this.descriptor.Readers[this.reader]
	if ok == false {
		return
	}
	namespaceName := strings.Join(readerDef.NamespaceParts, "::")

	this.writeEmptyLine(sb)
	this.writeLineFormat(sb,
		"} // namespace %s",
		namespaceName)
}

func (this *CppCodeGenerator) writeGlobalStructHeaderFileIncludeGuardStart(
	sb *strings.Builder, structDef *StructDef) {

	guardNameParts := make([]string, 0)
	guardNameParts = append(guardNameParts, "BRICKRED_TABLE_GENERATED")
	readerDef, ok := this.descriptor.Readers[this.reader]
	if ok {
		guardNameParts = append(
			guardNameParts, readerDef.NamespaceParts...)
	}
	guardNameParts = append(guardNameParts,
		g_notWordRegexp.ReplaceAllString(
			UtilCamelToUnderscore(structDef.Name), "_"))
	guardNameParts = append(guardNameParts, "H")
	guardName := strings.ToUpper(strings.Join(guardNameParts, "_"))

	this.writeLineFormat(sb,
		"#ifndef %s",
		guardName)
	this.writeLineFormat(sb,
		"#define %s",
		guardName)
}

func (this *CppCodeGenerator) writeGlobalStructHeaderFileIncludeGuardEnd(
	sb *strings.Builder) {

	this.writeEmptyLine(sb)
	this.writeLine(sb,
		"#endif")
}
